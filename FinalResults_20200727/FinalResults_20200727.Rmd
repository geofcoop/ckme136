---
title: "A predictive model for runs scored in a baseball game"
author: "Geoff Cooper [ geoffrey.cooper@ryerson.ca ]"
date: "July 27, 2020"
output:
  html_document:
    df_print: paged
subtitle: CKME136 - Initial Results
---
### Description
Initial results for a model containing all features proposed for the final model.
Training set is composed of game-by-game WHIP, DER and OPS, Test set is season to date average WHIP, DER and OPS.

### load packages
```{r}
# install.packages("FNN")
# install.packages("rpart")
# install.packages("ggplot2")
# install.packages("tidyverse")
# install.packages("dplyr")
# install.packages('Boruta')
```

### set working directory
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
wd = getwd() 
```

### open tor_games raw data
```{r}
datafile = paste(wd,"/tor_games_20200727.csv",sep="")
tor_games = read.csv(datafile) 
head(tor_games)
```

## 1. Create datasets

### Training dataset - game-by-game WHIP, DER and OPS
```{r}
tor_games_training <- data.frame(tor_games$tor_runs,tor_games$game_park_factor,tor_games$tor_home,tor_games$opp_pitcher_whip_game,tor_games$opp_team_der_game,tor_games$drurb001_ops_game,tor_games$bichb001_ops_game,tor_games$biggc002_ops_game,tor_games$davij007_ops_game,tor_games$fishd001_ops_game,tor_games$galvf001_ops_game,tor_games$gricr001_ops_game,tor_games$guerv002_ops_game,tor_games$hernt002_ops_game,tor_games$gurrl001_ops_game,tor_games$jansd001_ops_game,tor_games$maill001_ops_game,tor_games$mcgur002_ops_game,tor_games$mckib001_ops_game,tor_games$pillk001_ops_game,tor_games$smoaj001_ops_game,tor_games$sogae001_ops_game,tor_games$tellr001_ops_game)
names(tor_games_training) <- c('tor_runs','game_park_factor','tor_home','opp_pitcher_whip','opp_team_der','drurb001_ops','bichb001_ops','biggc002_ops','davij007_ops','fishd001_ops','galvf001_ops','gricr001_ops','guerv002_ops','hernt002_ops','gurrl001_ops','jansd001_ops','maill001_ops','mcgur002_ops','mckib001_ops','pillk001_ops','smoaj001_ops','sogae001_ops','tellr001_ops')
head(tor_games_training)
```

### Test dataset - season to date average WHIP, DER and OPS, last 150 games
```{r}
library(dplyr)
tor_games_test <- data.frame(tor_games$game_date,tor_games$tor_runs,tor_games$game_park_factor,tor_games$tor_home,tor_games$opp_pitcher_whip_todate,tor_games$opp_team_der_todate,tor_games$drurb001_ops_todate,tor_games$bichb001_ops_todate,tor_games$biggc002_ops_todate,tor_games$davij007_ops_todate,tor_games$fishd001_ops_todate,tor_games$galvf001_ops_todate,tor_games$gricr001_ops_todate,tor_games$guerv002_ops_todate,tor_games$hernt002_ops_todate,tor_games$gurrl001_ops_todate,tor_games$jansd001_ops_todate,tor_games$maill001_ops_todate,tor_games$mcgur002_ops_todate,tor_games$mckib001_ops_todate,tor_games$pillk001_ops_todate,tor_games$smoaj001_ops_todate,tor_games$sogae001_ops_todate,tor_games$tellr001_ops_todate)
names(tor_games_test) <- c('game_date','tor_runs','game_park_factor','tor_home','opp_pitcher_whip','opp_team_der','drurb001_ops','bichb001_ops','biggc002_ops','davij007_ops','fishd001_ops','galvf001_ops','gricr001_ops','guerv002_ops','hernt002_ops','gurrl001_ops','jansd001_ops','maill001_ops','mcgur002_ops','mckib001_ops','pillk001_ops','smoaj001_ops','sogae001_ops','tellr001_ops')
tor_games_test <- tor_games_test %>% filter(game_date > 20190409)
tor_games_test = subset(tor_games_test, select = -c(game_date))
head(tor_games_test)
```

## 2. Train regression models

### 2a. Linear regression model
```{r}
model_linreg <- lm(tor_runs~game_park_factor+tor_home+opp_pitcher_whip+opp_team_der+drurb001_ops+bichb001_ops+biggc002_ops+davij007_ops+fishd001_ops+galvf001_ops+gricr001_ops+guerv002_ops+hernt002_ops+gurrl001_ops+jansd001_ops+maill001_ops+mcgur002_ops+mckib001_ops+pillk001_ops+smoaj001_ops+sogae001_ops+tellr001_ops, tor_games_training)
summary(model_linreg)
```

### evaluate model
```{r}
linreg_predict_training <- predict(model_linreg, tor_games_training)
linreg_actuals_preds_training <- data.frame(cbind(actuals=tor_games_training$tor_runs, predicteds=linreg_predict_training))
correlation_accuracy_training <- cor(linreg_actuals_preds_training$actuals, y=linreg_actuals_preds_training$predicteds, method=c("spearman"))
# head(linreg_actuals_preds_training)
print("Correlation (r) - Predicted vs Actual")
correlation_accuracy_training
linreg_preds_errors <- (linreg_actuals_preds_training$actuals - linreg_actuals_preds_training$predicteds)
linreg_mspe = mean((linreg_preds_errors) ^ 2)
print("Mean squared prediction error")
linreg_mspe
print("Error distribution")
shapiro.test(linreg_preds_errors)
plot(linreg_actuals_preds_training$actuals, linreg_actuals_preds_training$predicteds, main="Plot of runs/game - Linear regression model - Training data", xlab="Actual (y)", ylab="Predicted (ŷ)")
abline(lm(linreg_actuals_preds_training$actuals~linreg_actuals_preds_training$predicteds), col="red")
```

### histogram of runs/game, Training data, actuals vs predicteds
```{r}
library(ggplot2)
actuals <- data.frame(tor_games_training$tor_runs)
actuals$dataset <- 'Actual'
names(actuals) <- c('Runs','Dataset')
predicteds <- data.frame(linreg_predict_training)
predicteds$dataset <- 'Predicted'
names(predicteds) <- c('Runs','Dataset')
runs <- rbind(actuals, predicteds)
ggplot(runs, aes(x=Runs, y=..count.., color=Dataset, fill=Dataset)) + geom_histogram(binwidth=1, alpha=0.5, position="dodge") + geom_density(alpha=0) + scale_fill_manual(values=c("darkblue", "lightblue")) + 
scale_color_manual(values=c("darkblue", "lightblue")) + labs(title="Histogram of Runs/Game by Toronto Blue Jays (2019 Season)\nActuals vs Training Set results",x="Runs", y="Games") + theme_classic()
```

## 2b. k-NN regression model

### remove outcome variable from training set
```{r}
library(dplyr)
knn_tor_games_actuals <- tor_games_training %>% select(tor_runs)
knn_tor_games_training <- tor_games_training %>% select(-tor_runs)
```

### set the seed to make the partition reproducible
set.seed(1234)

### train using 75% of the sample size
smp_size <- floor(0.75 * nrow(knn_tor_games_training))
train_ind <- sample(seq_len(nrow(knn_tor_games_training)), size = smp_size)

### creating test and training sets that contain all of the predictors
knn_train <- knn_tor_games_training[train_ind, ]
knn_test <- knn_tor_games_training[-train_ind, ]
knn_train_actuals <- knn_tor_games_actuals[train_ind, ]
knn_test_actuals <- knn_tor_games_actuals[-train_ind, ]

### train model
library(FNN)
model_knn <- knn.reg(knn_train, knn_test, knn_train_actuals, k = 6)
model_knn

### evaluate model
knn_cor <- cor(knn_test_actuals, y=model_knn$pred, method=c("spearman"))
# head(model_knn$pred)
print("Correlation (r) - Predicted vs Actual")
knn_cor
knn_preds_errors <- (knn_test_actuals - model_knn$pred)
knn_mspe = mean((knn_preds_errors) ^ 2)
print("Mean squared prediction error")
knn_mspe
print("Error distribution")
shapiro.test(knn_preds_errors)
plot(knn_test_actuals, model_knn$pred, xlab="Actual (y)", ylab="Predicted (ŷ)")
abline(lm(model_knn$pred~knn_test_actuals), col="red")

## 2c. Regression tree model

# train model
library(rpart)
model_regtree <- rpart(tor_runs~game_park_factor+tor_home+opp_pitcher_whip+opp_team_der+drurb001_ops+bichb001_ops+biggc002_ops+davij007_ops+fishd001_ops+galvf001_ops+gricr001_ops+guerv002_ops+hernt002_ops+gurrl001_ops+jansd001_ops+maill001_ops+mcgur002_ops+mckib001_ops+pillk001_ops+smoaj001_ops+sogae001_ops+tellr001_ops, method="anova", data=tor_games_training)

printcp(model_regtree) # display the results
plotcp(model_regtree) # visualize cross-validation results
summary(model_regtree) # detailed summary of splits

# create additional plots
par(mfrow=c(1,2)) # two plots on one page
rsq.rpart(fit) # visualize cross-validation results 

# plot tree
plot(model_regtree, uniform=TRUE, main="Regression Tree for Runs Scored")
text(model_regtree, use.n=TRUE, all=TRUE, cex=.8)

# create attractive postcript plot of tree
psfile = paste(wd,"/model_regtree.ps",sep="")
post(model_regtree, file = psfile, title = "Regression Tree for Runs Scored")

### evaluate model
regtree_preds <- predict(model_regtree,type = "vector")
# head(regtree_preds)
regtree_cor <- cor(tor_games_training$tor_runs, y=regtree_preds, method=c("spearman"))
print("Correlation (r) - Predicted vs Actual")
regtree_cor
regtree_preds_errors <- (tor_games_training$tor_runs - regtree_preds)
regtree_mspe = mean((regtree_preds_errors) ^ 2)
print("Mean squared prediction error")
regtree_mspe
print("Error distribution")
shapiro.test(regtree_preds_errors)
plot(tor_games_training$tor_runs, jitter(regtree_preds,2), xlab="Actual (y)", ylab="Predicted (ŷ)")
abline(lm(regtree_preds~tor_games_training$tor_runs), col="red")

## 3. Evaluate model - baseline

### evaluate model on Test data
```{r}
model_predict_test <- predict(model_fit, tor_games_test)
actuals_preds_test <- data.frame(cbind(actuals=tor_games_test$tor_runs, predicteds=model_predict_test))
correlation_accuracy_test <- cor(actuals_preds_test)
```
#### correlation of runs/game, Test data, actuals vs predicteds
```{r}
correlation_accuracy_test
actuals_preds_test
```
#### Means of actuals, predicteds
```{r}
mean(actuals_preds_test$actuals)
mean(actuals_preds_test$predicteds)
```
#### Normality of actuals, predicteds
```{r}
shapiro.test(actuals_preds_test$actuals)
shapiro.test(actuals_preds_test$predicteds)
```

### histogram of runs/game, Test set, actuals vs predicteds
```{r}
actuals <- data.frame(tor_games_test$tor_runs)
actuals$dataset <- 'Actual'
names(actuals) <- c('Runs','Dataset')
predicteds <- data.frame(model_predict_test)
predicteds$dataset <- 'Predicted'
names(predicteds) <- c('Runs','Dataset')
runs <- rbind(actuals, predicteds)
ggplot(runs, aes(x=Runs, y=..count.., color=Dataset, fill=Dataset)) + geom_histogram(binwidth=1, alpha=0.5, position="dodge") + geom_density(alpha=0) + scale_fill_manual(values=c("darkblue", "lightblue")) + 
scale_color_manual(values=c("darkblue", "lightblue")) + labs(title="Histogram of Runs/Game by Toronto Blue Jays (2019 Season)\nActuals vs Test Set results - baseline model",x="Runs", y="Games") + theme_classic()
```

### plot of runs/game Test data, actuals vs predicteds
```{r}
plot(actuals_preds_test$predicteds, actuals_preds_test$actuals, main="Plot of runs/game - Test data - baseline model", xlab="Predicted", ylab="Actual")
abline(lm(actuals_preds_test$actuals~actuals_preds_test$predicteds), col="red")
```

## 4. Revise model

### revise model using feature selection
```{r}
library(Boruta)
boruta_output <- Boruta(tor_runs~., data=tor_games_training, doTrace=0, maxRuns=500)
boruta_output
plot(boruta_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")
boruta_table <- attStats(boruta_output)
boruta_table
```

### remove outlier, one game where runs > 13
```{r}
tor_games_training <- tor_games_training %>% filter(tor_runs < 13)
tor_games_test <- tor_games_test %>% filter(tor_runs < 13)
```

## 5. Train model - revised

### train revised regression model - use only important WHIP, DER, OPS game values
```{r}
model_fit <- lm(tor_runs~opp_pitcher_whip+opp_team_der+biggc002_ops+gricr001_ops+guerv002_ops+hernt002_ops+gurrl001_ops+jansd001_ops, tor_games_training)
summary(model_fit)
```

## 6. Evaluate model - revised

### use revised model on Test data - WHIP, DER, OPS todate average values
```{r}
model_predict_test <- predict(model_fit, tor_games_test)
actuals_preds_test <- data.frame(cbind(actuals=tor_games_test$tor_runs, predicteds=model_predict_test))
correlation_accuracy_test <- cor(actuals_preds_test)
```
#### correlation, Test data, actuals vs predicteds
```{r}
correlation_accuracy_test
actuals_preds_test
```

#### Means of actuals, predicteds sets
```{r}
mean(actuals_preds_test$actuals)
mean(actuals_preds_test$predicteds)
```
#### Normality of actuals, predicteds sets
```{r}
shapiro.test(actuals_preds_test$actuals)
shapiro.test(actuals_preds_test$predicteds)
```
### histogram of runs/game, Test set, actuals vs predicteds
```{r}
actuals <- data.frame(tor_games_test$tor_runs)
actuals$dataset <- 'Actual'
names(actuals) <- c('Runs','Dataset')
predicteds <- data.frame(model_predict_test)
predicteds$dataset <- 'Predicted'
names(predicteds) <- c('Runs','Dataset')
runs <- rbind(actuals, predicteds)
ggplot(runs, aes(x=Runs, y=..count.., color=Dataset, fill=Dataset)) + geom_histogram(binwidth=1, alpha=0.5, position="dodge") + geom_density(alpha=0) + scale_fill_manual(values=c("darkblue", "lightblue")) + 
scale_color_manual(values=c("darkblue", "lightblue")) + labs(title="Histogram of Runs/Game by Toronto Blue Jays (2019 Season)\nActuals vs Test Set results - revised model",x="Runs", y="Games") + theme_classic()
```

### plot of runs/game Test data, actuals vs predicteds
```{r}
plot(actuals_preds_test$predicteds, actuals_preds_test$actuals, main="Plot of runs/game - Test data - revised model", xlab="Predicted", ylab="Actual")
abline(lm(actuals_preds_test$actuals~actuals_preds_test$predicteds), col="red")
```